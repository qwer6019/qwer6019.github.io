---
type: posts
title: "Consensus Algorithms"
categories: [Blockchain]

---
<!--snippet-->
<p>
	<h2>합의 알고리즘</h2>
		<h3>Reference: https://steemit.com/consensus/@kblock/48-pbft-consensus-algorithm</h3>
		<br><b class="taxonomy">합의 알고리즘</b>은 분산 시스템 환경에서 데이터의 일관성을 위해 제안된 개념으로써 블록체인의 경우 모든 노드들이 일관된 거래 내역들이 담긴 동일한 블록을 보유하기 위해 필요하다. 블록체인에 사용되는 합의 알고리즘을 이해하기 위해서는 기존 분산 환경에서 나타나는 <b class="taxonomy">비잔틴 장군 문제</b>와 이를 해결하는 <b class="funccolor">비잔틴 장애 허용(Byzantine Fault Tolerance)</b> 알고리즘을 이해해야 한다.
		<br><br>합의 알고리즘이 네트워크에 통용되기 위해선 두 가지 특성이 필요하다.
		<ul>
			<li><b class="taxonomy">Safety:</b> 노드 간 합의가 발생했다면, 그 값은 모든 노드에서 동일하다. (일관성)</li>
			<li><b class="taxonomy">Liveness:</b> 합의 대상(거래 또는 블록)에 문제가 없다면, 네트워크 내에서 반드시 합의가 이루어진다.</li>
		</ul>
		하지만, 비동기 네트워크에서 두 가지 특성을 완벽히 만족하는 합의 알고리즘을 설계하는 것이 불가능하다는 것이 증명되었기 때문에 <b class="funccolor">(FLP Impossibility)</b> 비동기 네트워크인 블록체인에서의 합의 알고리즘은 두 특성 중 중 하나를 어느 정도 포기한다.
			<ul><li>Fischer, Michael J, et al. Impossibility of distributed consensus with one faulty process. 1982.</li></ul>
		<br>현재 블록체인 합의 알고리즘 중 BFT를 사용하는 경우 대부분 <b class="funccolor">PBFT(Practical Byzantine Fault Tolerance)</b> 합의 알고리즘을 바탕으로 하며 이는 비잔틴 장군 문제가 발생할 수 있는 상황에서도 네트워크의 합의를 보장한다. 이는 safety를 충족하는 대신 liveness를 일부 희생한다. 즉, 네트워크 내 일부 배신자 노드가 존재하더라도 합의의 신뢰를 보장하는 알고리즘입니다.<br>
		<br>PBFT 합의 알고리즘의 자세한 알고리즘은 상단 URL 또는 논문을 참조하며 (URL의 경우 일부 오류가 있으므로 댓글을 참조) 이를 이용한 블록체인은 다음과 같다.
		<ul>
			<li><b class="taxonomy">Tendermint</b>: PBFT 에 DPoS 합의 알고리즘을 결합</li>
			<li><b class="taxonomy">이더리움의 Casper:</b> PoW 위에 PoS + PBFT 합의 알고리즘 결합</li>
			<li><b class="taxonomy">Hyperledger Fabric, Ripple, EOS</b> 등</li>
		</ul>
	<h2>작업 증명(Proof of Work)</h2>
		<b class="taxonomy">작업 증명</b>방식의 합의 알고리즘은 아래와 같은 단점들이 존재한다.
		<ul>
			<li>모든 채굴자가 거래들을 담은 고유 블록을 생성하고 작업 증명을 시도하므로 막대한 <b class="funccolor">에너지</b>가 소비</li>
			<li>해시 파워를 증가시키기 위해 채굴 풀을 운영하거나 고가의 하드웨어를 설치함으로써 <b class="funccolor">중앙화</b>를 야기</li>
			<li><b class="funccolor">확장성</b> 문제</li>
			<ul>
				<li><b class="boldcolor">블록 난이도</b>를 낮추어 블록 생성 속도를 증가시키는 경우 <b class="taxonomy">uncle block(stale block)</b> 생성이 증가하므로 채굴자의 기대 수익이 낮아진다. 이는 해시 파워가 높은 마이닝 풀이 유리해지므로 채굴의 중앙화가 심화되어 안전성이 낮아진다.
				</li>
				<ul>
					<li><b class="taxonomy">엉클 블록:</b> 채굴에 성공한 블록이 네트워크를 통해 다른 노드들에게 전파되는데 시간이 걸리므로 또 다른 채굴자가 블록 채굴을 성공할 수 있다. 이러한 블록들을 지칭하며 엉클 블록 또한 유효성을 지니나 메인 체인에 연결되지는 못한다.</li>
				</ul>
				<li><b class="boldcolor">블록 크기</b>를 증가시키는 경우<b class="taxonomy">(빅블록)</b> 네트워크 상에서 전송되는 데이터의 양이 늘어나므로 전파 속도가 저하되고 엉클 블록의 생성을 증가시킨다. 이는 마찬가지로 컴퓨팅 파워가 큰 채굴자들에 의해 중앙화될 수 있다.</li>
			</ul><br>
			따라서, 다른 방식의 합의 알고리즘들이 등장하였다.
		</ul>
	<h2>지분 증명(Proof of Stake)</h2>
			<b class="taxonomy">지분 증명</b>의 합의 과정은 다음과 같다.
			<ul>
				<li>모든 노드는 언제든지 원하는 라운드에 <b class="taxonomy">검증자(validator)</b>가 되어 블록 생성을 시도할 수 있다.</li>
					<ul><li>검증자가 되기 위해서는 노드는 일부 코인을 네트워크에 묶어두며 이를 <b class="taxonomy">지분</b>이라고 하며, 검증자들로 이루어진 <b class="taxonomy">검증 풀</b>에 추가된다.</li></ul>
				<li>블록을 생성하고 결정하는 과정은 두 가지 방식이 있다.</li>
					<ul>
						<li><b class="taxonomy">Chain based PoS:</b> 블록 생성 주기마다 의사 랜덤하게 검증가 선출되어 블록을 <b class="boldcolor">생성</b>한다.</li>
						<li><b class="taxonomy">BFT style PoS:</b> 블록 생성 주기마다 랜덤하게 검증자들은 블록들을 <b class="boldcolor">제안</b>한다.
						검증자들은 제안된 블록에 지분을 이용하여 동의할 수 있고, 여러 블록 중 과반수(51%)의 동의를 먼저 받은 블록이 <b class="boldcolor">생성</b>하도록 결정된다.</li>
					</ul>
				<li>결정된 블록을 처리할 검증자가 랜덤 기반의 특정 선거 절차를 통해 <b class="funccolor">결정적(deterministic)</b>으로 선택된다.</li>
					<ul><li>지분의 크기가 결정된 블록의 검증자로 선택될 확률이 증가하며 선형적인 관계를 이룬다.</li></ul>
				<li>선택된 검증자는 블록 안의 모든 거래가 유효한지를 확인한 후 블록체인에 추가하고 보상으로 거래 수수료들을 획득한다.
					<ul><li>블록 보상은 없으며 이는 새로운 코인이 추가되지 않으므로 초기 발행량이 정해져 있음을 의미한다.</li></ul>
				</li>
				<br><h3>그렇다면 선택된 검증자를 어떻게 신뢰할 수 있을까?</h3><br>
				<li>노드는 검증자로서의 역할을 그만두는 경우 일정 시간 (블록 검증을 위함) 이후 그의 지분과 획득한 수수료가 반환되는데 생성된 블록의 검증 과정에서 검증자가 유효하지 않은 거래를 승인한 경우 지분의 일부를 반환 받을 수 없다.	</li>
			</ul>
			<br>따라서, PoS는 PoW와 달리 막대한 연산이 필요하지 않으므로 구축 비용이 덜 들어가며 에너지 소비 또한 크지 않다.
				<ul><li>고성능의 하드웨어를 또는 채굴 풀 등이 필요하지 않아 누구나 참여할 수 있어 PoW에 비해 중앙화 문제점이 줄어든다.</li></ul>
			<br><h3>하지만 PoS 방식 역시 여러 공격 루트와 문제점을 지니며 대처법은 아래와 같다.</h3>
			<ul>
				<li><b class="taxonomy">51% 공격:</b> 지분의 51%를 보유하기 위해서는 막대한 돈이 필요하므로 발생하기 어려우며 또한 이러한 공격은 공격자가 지니고 있는 코인 가치 또한 떨어뜨리므로 공격 동기를 떨어뜨린다.
				</li>
				<li><b class="taxonomy">Nothing at stake:</b> 검증자가 포크가 발생 한 여러 체인의 블록에 투표할 수 있다. 이는 여러번 투표하더라도 노드에 어떠한 손해가 가해지지 않는, 무위험 베팅이기 때문이다.</li>
					<ul>
						<li>이는 <b class="funccolor">이중지출</b> 문제를 야기할 수 있기 때문에 상충되는 거래의 블록들에 서명하는 경우 유효성 검증자 또는 제 3자를 통해 확인 후 지분을 삭감하는 식으로 벌칙을 부과할 수 있다.</li>
						<li>하지만, 지분 보유자가 블록들의 동의된 지분 정도에 따라 선택 가능성이 높은 블록으로 선택을 바꿀 자유도 있기 때문에 모든 가능한 경우에 벌칙을 부과하는 경우 합당하지 않다.</li>
						<li>딜레마를 해결하기 위한 다양한 방식들이 제안되고 있으며, 초기 캐스퍼 개선안의 경우 지분 변경 횟수에 따라 벌금 부과량을 차등하는 방식을 사용했다. <b class="boldcolor">(이후 변경안은 찾아봐야 한다.)</b></li>
					</ul>
				<li>지분이 많을 수록 검증자로 선정될 가능성이 높아지고 선정된 검증자는 수수료를 받음으로써 더욱 지분이 많아진다. 
					<br>이러한 악순환을 방지하기 위해 제시된 해결책 중 하나는 지분의 나이에 기반하여 선정하는 방식이다. 즉, 시간이 지날수록 지분의 나이는 증가하여 선정된 가능성을 높이고 블록 생성에 사용된 지분은 나이가 초기화 되는 방식이다.</li>
			</ul>
			<h3>이더리움은 PoW와 PoS를 혼합한 하이브리드 방식의 캐스퍼 프로젝트를 공개하였다. (2018)</h3>
			<ul>
				<li>PoS 의 참여자들은 보유하는 이더리움을 검증자 풀에 보내고 풀에 있는 자금의 3분의 2가 개선안의 프로토콜에 동의하면, 해당 블록은 완결된 블록으로 간주된다.</li>
					<ul>
						<li>PoS 는 체크포인팅 시스템으로써 PoW 에 대한 추가적인 보호 레이어를 제공하기 위해 100개의 블록만을 사용한다.</li>
							<ul><li>검증자들은 마지막 체크포인트 블록 이후의 유효한 12개의 승인된 블록에 대해서만 투표한다.</li></ul>
						<li>정족수 (3분의 2)에 도달하지 못할 경우, 해당 블록체인은 전적으로 PoW 에 기반해 거래를 이어갑니다.</li>
					</ul>
				<li>완결성을 갖춘 블록은 PoW 시스템에 대한 우선권을 얻는다. (따라서 PoW 과정에 따른 에너지 문제가 없다.)</li>
				<li>지분보유자가 속임수를 이용해 서로 상충되는 개선안에 투표할 경우 대가로 4%의 수수료 패널티를 받게 된다. 
				<br>제 3자인 검증자는 이를 불법 투표에 대한 증거로 제시할 수 있고 속임수를 이용해 수수료를 받은 지분보유자는 보유한 지분과 예치금 전부를 몰수당하게됩니다.</li>
			</ul><br>
	<h2>위임 지분 증명(Delegated Proof of Stake)</h2>
		<ul>
			<li>토큰을 지니는 노드들의 투표를 통해 일정 수의 <b class="taxonomy">대표자(delegate)</b>를 선출하며 각 투표 가중치는 계좌가 지니고 있는 토큰의 양에 의해 결정된다.
			</li>			
			<li>현재 대표자 수</li>
				<ul><li>EOS:21, BitShares:101, Steemit:21, Ark;51</li></ul>
			<li>대표자는 네트워크를 안전하고 지속적으로 유지해야 계속 선택받을 수 있으며 주요 역할은 아래와 같다.
				<ul>
					<li>그들의 노드가 계속 동작하도록 관리한다.</li>
					<li>네트워크 내 거래를 블록들에 수집한다.</li>
					<li>블록에 서명하고 브로드캐스팅하며 거래들을 검증한다.</li>
				</ul> 
			</li>
			<li>N개의 대표자가 있을 때 블록이 생성되는 한 라운드는 다음과 같다.</li>
				<ul>
					<li>N개의 대표자들이 대표자 후보군에서 선출됨</li>					
					<li>i번째 대표자가 i번째 블록을 서명(i=N이 될 때까지)</li>
					<li>대표자의 (2/3+1)가 투표하면 한 블록이 확정(즉, 되돌릴 수 없음). 그렇지 않으면 긴 체인 규칙을 따릅니다.</li>
					<li>각각의 DPoS 구현에서 블록 보상 및 인플레이션 메커니즘은 각 프로젝트의 보상 모델에 따라 달라진다.</li>
					<li>유권자들은 대표자들이 악의적인 것으로 밝혀지면 다음 라운드에서 해당 대표자에게 투표하지 않음으로써 대표자를 해고할 수 있다.</li>
						<ul>
							<li>대표자들은 거래의 세부사항을 바꿀 권한을 갖지 못한다. 하지만 검증자로서 특정 거래를 배제할 수 있는 권한은 있다. 하지만 배제된 거래는 다음 블록에 추가될 것이므로 큰 영향이 없다. 또한 이러한 행위는 다음 투표에 의해 대표자로서의 권리를 잃어버리는 결과를 초래한다.</li>
							<li><b class="boldcolor">어떻게 특정 거래를 배제했는지 확인하는가?</b></li>
							<li><b class="boldcolor">확인된 경우 어떻게 대표자를 박탈하는가?(즉, 기존 어떻게 대표자에게 투표하는가)</b></li>
						</ul>
				</ul>
			<li>대표자는 생산된 블록이 합의 규칙을 준수하는지를 확인하며 모든 사용자는 블록 검증자를 실행하여 네트워크를 검증할 수 있다.</li>
		</ul>
		위와 같은 방식으로 DPos 네트워크는 모든 참여자들에 의해 올바르게 동작하도록 보장받으며 대표자의 수가 제한되어 있기 때문에, DPoS 는 오늘날의 PoW 보다 큰 규모의 트랜잭션을 처리할 수 있다.
</p>

<p class="quotes">
“What you do makes a difference, and you have to decide what kind of difference you want to make.” <br>
<div class="quotes__poet">― Jane Goodall</div>
</p>



